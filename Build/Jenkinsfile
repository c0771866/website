pipeline {
  agent any
  
  environment {
    AWS_ACCESS_KEY_ID = credentials('aws-access-key-id')
    AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
    AWS_DEFAULT_REGION = 'us-west-2'
  }
  
  stages {
    stage('Checkout') {
      steps {
        git branch: 'main',
            credentialsId: 'github-credentials',
            url: 'https://github.com/your/repo.git'
      }
    }
    
    stage('Terraform Init') {
      steps {
        terraformInit(
            backendS3: true,
            backendS3Bucket: 'my-terraform-state-bucket',
            backendS3Key: 'webapp/terraform.tfstate',
            backendS3Region: 'us-west-2',
            workingDirectory: 'terraform'
        )
      }
    }
    
    stage('Terraform Plan') {
      steps {
        terraformPlan(
            vars: [
                'aws_region=us-west-2',
                'db_username=myuser',
                'db_password=mypassword',
                'db_name=mydatabase',
                'allowed_ips=["0.0.0.0/0"]'
            ],
            workingDirectory: 'terraform'
        )
      }
    }
    
    stage('Terraform Apply') {
      steps {
        terraformApply(
            autoApprove: true,
            vars: [
                'aws_region=us-west-2',
                'db_username=myuser',
                'db_password=mypassword',
                'db_name=mydatabase',
                'allowed_ips=["0.0.0.0/0"]'
            ],
            workingDirectory: 'terraform'
        )
      }
    }
    
    stage('Deploy') {
      steps {
        sh 'npm install'
        sh 'npm run build'
        sh 'aws s3 sync dist/ s3://my-bucket/'
      }
    }
  }
}

